<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
      <title>Cyclists' Skin Conductivity in 3D - Netherlands</title>
      <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
      <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.51.0/mapbox-gl.js'></script>
      <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.51.0/mapbox-gl.css' rel='stylesheet' />

    <style>
        body {
              margin: 0;
              padding: 0;
              font-family: 'Helvetica Neue', Helvetica, Arial, Sans-serif;
            }

            #map {
              position: absolute;
              top: 0;
              bottom: 0;
              width: 100%;
            }
            #pano {
                float: left;
                height: 100%;
                width: 45%;
            }
/*            #menu {
                position: relative;
                background: rgba(225, 225, 225, .5);
                bottom: -570px;
                border: 3px solid #000000;
                padding: 5px 5px;
                width: 37%;
                height: 100%;
                right: -100px;
                font-family: 'Helvetica Neue', Helvetica, Arial, Sans-serif;
                font-size: 12px;
            }*/

            h1 {
              font-size: 16px;
              line-height: 16px;
              color:#696969;
            }

            h2 {
              font-size: 14px;
              line-height: 14px;
              margin-bottom: 8px;
              color:#696969;
            }

            a {
              text-decoration: none;
              color:#2dc4b2;
            }

            #console {
              position: relative;
              top: 10px;
              width: 200px;
              margin: 10px;
              padding: 10px 10px;
              background: rgba(225, 225, 225, .55);
              border: 3px solid #696969; ;
              /*color: #fff;*/
              /*text-shadow: #343a40 2px 2px;*/
                /*min-width: 100%;
                min-height: 12em;
                position: relative;*/
            }
            #legend {
                /* right: 50%;
        margin-right: -250px;*/
              position: fixed;
              /*top: 335px;*/
              width: 200px;
              margin: 10px;
              right:-5%;
              bottom:5%;
              padding: 5px 5px;
              background: transparent;
              /*background: rgba(225, 225, 225, .5);*/
              /*border: 3px solid #000000 ;*/
              /*color: #fff;*/
              /*text-shadow: #343a40 2px 2px;*/
                /*min-width: 100%;
                min-height: 12em;
                position: relative;*/
            }
            #github {
              position: fixed;
              /*top: 335px;*/
              width: 200px;
              margin: 10px;
              left:5%;
              bottom:-2.5%;
              /*padding: 5px 5px;*/
              background: transparent;
            }
            .session {
              margin-bottom: 10px;
              height: 20px;
              width: 100%;
            }

            .row {
              height: 12px;
              width: 100%;
            }

            .colors {
              background: linear-gradient(to left, #b2182b, #f4a582, #f7f7f7, #92c5de, #2166ac);
              margin-left: 1px;
              width: 70%;
            }
            .label {
              width: 48%;
              display: inline-block;
              text-align: left;
              margin-left: 1.5px;
              font-size: 10px;
              color:#696969;
            }
    </style>
</head>
<body>
    <style>
    .mapboxgl-popup {
        max-width: 400px;
        font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
    }
    </style>
    <div id='map'></div>
<!--     <div id='menu'>
         <h2>Layers</h2>
        <input id='basic' type='radio' name='rtoggle' value='basic' checked='checked'>
        <label for='basic'>basic</label>
        <input id='streets' type='radio' name='rtoggle' value='Streets'>
        <label for='streets'>streets</label>
        <input id='bright' type='radio' name='rtoggle' value='Bright'>
        <label for='bright'>bright</label>
        <input id='light' type='radio' name='rtoggle' value='Light'>
        <label for='light'>light</label>
        <input id='dark' type='radio' name='rtoggle' value='Dark'>
        <label for='dark'>dark</label>
        <input id='satellite' type='radio' name='rtoggle' value='Satellite'>
        <label for='satellite'>satellite</label>
    </div> -->
    <div id="street-view"></div>
    <div id="pano"></div>
    <div id='console'>
      <h1>Mapping Emotion in 3D</h1>
      <p>Cyclists' Skin Conductivity <br>in the Netherlands</p>
      <!-- <div class='session'>
      <h2>Skin Conductivity</h2>
      <div class='row colors'>
      </div>
      <div class='row labels'>
        <div class='label'>Calm</div>
        <div class='label'>Stressed</div> -->
      </div>
      <div id='legend'>
      <!-- <h1>Mapping Emotion in 3D</h1>
      <p>Cyclists' Skin Conductivity <br>in the Netherlands</p>
      <p>GitHub: <a href='https://github.com/gcmillar/3D-Buildings-NL'>G.C. Millar</a></p> -->
      <div class='session'> 
      <h2>Skin Conductivity</h2>
      <div class='row colors'>
      </div>
      <div class='row labels'>
        <div class='label'><b>Calm</b></div>
        <div class='label'><b>Stressed</b></div>
      </div>
      <div id='github'>
        <a href="https://github.com/gcmillar/3D-Buildings-NL" title="Check me out on GitHub" alt="octocat">
            <img src="img/git_logo.png" width="110" height="39">
        </a>
      </div>
    </a>
</div>
    </div>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiZ2NtaWxsYXIiLCJhIjoiY2pvcDhrbGl4MDFvaTNrczR0d2hxcjdnNSJ9.JYgBw6y2pEq_AEAOCaoQpw';
var map = new mapboxgl.Map({
    style: 'mapbox://styles/mapbox/streets-v9',
    center: [5.06, 51.5960], 
    zoom: 12,
    pitch: 100,
    tilt: 100,
    // bearing: -17.6,
    container: 'map'
});

// var layerList = document.getElementById('menu');
// var inputs = layerList.getElementsByTagName('input');

// function switchLayer(layer) {
//     var layerId = layer.target.id;
//     map.setStyle('mapbox://styles/mapbox/' + layerId + '-v9');
// }

// for (var i = 0; i < inputs.length; i++) {
//     inputs[i].onclick = switchLayer;
// }

// //set color of marker based on feature value
// function getColor(x) {
//     return  x < 500     ?   'blue':
//             x > 1000    ?   'red':
//                             'grey' ;
// }

// //set color of marker based on feature value
// function getColor(x) {
//     return  x.properties.conductance_z < 500     ?   'blue':
//             x.properties.conductance_z > 1000    ?   'red':
//                             'grey' ;
// }

// The 'building' layer in the mapbox-streets vector source contains building-height
// data from OpenStreetMap.
map.on('load', function() {
    // Insert the layer beneath any symbol layer.
    var layers = map.getStyle().layers;

    // var url = 'https://raw.githubusercontent.com/gcmillar/3D-Buildings-NL/master/pt1_test_geojson_simple.geojson';

    var labelLayerId;
    for (var i = 0; i < layers.length; i++) {
        if (layers[i].type === 'symbol' && layers[i].layout['text-field']) {
            labelLayerId = layers[i].id;
            break;
        }
    }

    map.addLayer({
        'id': '3d-buildings',
        'source': 'composite',
        'source-layer': 'building',
        'filter': ['==', 'extrude', 'true'],
        'type': 'fill-extrusion',
        'minzoom': 12,
        'paint': {
            'fill-extrusion-color': '#c6bdff',

            // use an 'interpolate' expression to add a smooth transition effect to the
            // buildings as the user zooms in
            'fill-extrusion-height': [
                "interpolate", ["linear"], ["zoom"],
                10, 0,
                10.05, ["get", "height"]
            ],
            'fill-extrusion-base': [
                "interpolate", ["linear"], ["zoom"],
                10, 0,
                10.05, ["get", "min_height"]
            ],
            'fill-extrusion-opacity': .5
        }
    }, labelLayerId);

    // Add zoom and rotation controls to the map.
    map.addControl(new mapboxgl.NavigationControl());

});

var url = 'https://raw.githubusercontent.com/gcmillar/3D-Buildings-NL/master/pt1_test_geojson_simple.geojson';

map.on('load', function () {
    window.setInterval(function() {
        map.getSource('pt1_test_geojson_simple').setData(url);
    }, 2000);

    map.addSource('pt1_test_geojson_simple', { type: 'geojson', data: url });
    map.addLayer({
        "id": "pt1_test_geojson_simple",
        "type": "circle",
        "source": "pt1_test_geojson_simple",
        "paint": {
            "circle-radius": {
                'base': 6,
                'stops': [[12, 6], [70, 350]],
            },
            "circle-opacity": 1,
            "circle-color": {
              property: 'conductance_z',
              type: 'exponential',
              stops: [
                [-12361.2246720,'#2166ac'],
                // [-0.8704912, '#d6604d']
                // [-0.5898474, '#4393c3'],
                // [-0.2839074, '#fddbc7'],
                [0.1773300, '#92c5de'],
                // [0.3573693, '#d1e5f0'],
                // [0.6403849, '#f7f7f7'],
                [2647.7223040, '#f4a582'],
                [28208.5369920, '#b2182b'],
                // ["grey"]
                ]
            }
        }
    });

    // When a click event occurs on a feature in the places layer, open a popup at the
    // location of the feature, with description HTML from its properties.
    map.on('click', 'pt1_test_geojson_simple', function (e) {
        var coordinates = e.features[0].geometry.coordinates.slice();
        // var myPano = new google.maps.StreetViewPanorama(document.getElementById("pano"), panoramaOptions);
        // function initialize() {
        //     var panoramaOptions = {
        //       position: coordinates,
        //       pov: {
        //         heading: 165,
        //         pitch:0,
        //         zoom:1
        //       }
        //     };
        // myPano.setVisible(true);
        // }

        var google_coords = e.features[0].geometry.coordinates;

        var panorama;
        function initialize() {
            panorama = new google.maps.StreetViewPanorama(
                document.getElementById('street-view'),
                {
                  position: (5.06, 51.6279),
                  pov: {heading: 165, pitch: 0},
                  zoom: 1
                });
            }
        var description = e.features[0].properties.conductance_z;

        // Ensure that if the map is zoomed out such that multiple
        // copies of the feature are visible, the popup appears
        // over the copy being pointed to.
        while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
            coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
        }

        // // var google_coords = toString(coordinates) 
        // var google_coords = toString(e.features[0].geometry.coordinates);
        // var google_street_url = 'https://maps.googleapis.com/maps/api/streetview?location='+coordinates+'&size=456x456&key=AIzaSyBu_V_VjxdF38X1N6LvehcnOnc2YdjcFUE&signature=BASE64_SIGNATURE';

        new mapboxgl.Popup({closeOnClick: true})
            .setLngLat(coordinates)
            // .setHTML(panorama)
            .setHTML('Skin Conductivity: ' + description) // + panorama
            // .setHTML(new mapboxgl.Popup(panorama)) // add street view popup
            .addTo(map);
    });

    // Change the cursor to a pointer when the mouse is over the places layer.
    map.on('mouseenter', 'pt1_test_geojson_simple', function () {
        map.getCanvas().style.cursor = 'pointer';
    });

    // Change it back to a pointer when it leaves.
    map.on('mouseleave', 'pt1_test_geojson_simple', function () {
        map.getCanvas().style.cursor = '';
    });

});
</script>

<script type="text/html" src="//maps.googleapis.com/maps/api/js?key=AIzaSyBu_V_VjxdF38X1N6LvehcnOnc2YdjcFUE"></script>

</body>

</html>
